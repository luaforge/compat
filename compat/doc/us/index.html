<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<title>Compat-5.1: Lua 5.1 Package Compatibility for Lua 5.0</title>
    <link rel="stylesheet" href="http://www.keplerproject.org/doc.css" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>
<body>

<div id="container">
	
<div id="product">
	<div id="product_logo"><a href="http://www.keplerproject.org">
		<img alt="Compat logo" src="compat.png"/>
	</a></div>
	<div id="product_name"><big><strong>Compat-5.1</strong></big></div>
	<div id="product_description">Lua 5.1 Package Compatibility for Lua 5.0</div>
</div> <!-- id="product" -->

<div id="main">
	
<div id="navigation">
<h1>Compat-5.1</h1>
	<ul>
		<li><strong>Home</strong>
			<ul>
				<li><a href="index.html#overview">Overview</a></li>
				<li><a href="index.html#status">Status</a></li>
				<li><a href="index.html#download">Download</a></li>
				<li><a href="index.html#history">History</a></li>
				<li><a href="index.html#comments">Comments</a></li>
				<li><a href="index.html#reference">Reference</a></li>
				<li><a href="index.html#examples">Examples</a></li>
				<li><a href="index.html#credits">Credits</a></li>
				<li><a href="index.html#contact">Contact us</a></li>
			</ul>
		</li>
		<li><a href="license.html">License</a></li>
	</ul>
</div> <!-- id="navigation" -->

<div id="content">

<h2><a name="over"></a>Overview</h2>

<p>The Package Compatibility (Compat-5.1) is a set of files which
provides an implementation of the new package model of Lua 5.1 to
be used in Lua 5.0.
The set of files consists of a Lua file and a
pair of a C source and header files.</p>

<p>The Lua file reimplements the function <code>require</code>
following the new behavior and adds the function <code>module</code>;
it also defines the table <code>package</code> and its standard fields:
<code>path</code>, <code>cpath</code>, <code>loaded</code> and
<code>preload</code>.</p>

<p>The C source file implements the function <code>luaL_module</code>.
This function can replace the original <code>luaL_openlib</code>
function.</p>

<p>Compat-5.1 is free software and uses the same <a href=
"license.html">license</a> as Lua 5.0. <a name="version"></a></p>

<p>
The original message of the proposal could be found
<a href="http://lua-users.org/lists/lua-l/2004-09/msg00342.html">here</a>.
</p>



<h2><a name="status"></a>Status</h2>

<p>
Current version is compat-5.1 release 3 (following Lua 5.1 work 6 implementation).
It was developed for Lua 5.0.
</p>


<h2><a name="download"></a>Download</h2>

<p>Compat-5.1 are a set of source files that can be downloaded from the
<a href="http://luaforge.net/projects/compat/files">LuaForge
page</a>.</p>



<h2><a name="history"></a>History</h2>

<ul>
<li>[20/May/2005] Release 3</li>
<li>[23/Dec/2004] Release 2</li>
<li>[29/Oct/2004] Release 1</li>
</ul>

<p>
Release 3 follows the implementation of Lua 5.1 work 6.
The differences are on the implementation (see some
<a href="#comments">technical comments</a> for more information).
</p>
<p>
Compat-5.1 release 2 fixes some bugs and misconceptions.
It was based on the implementation of Lua 5.1 work 3.
</p>



<h2><a name="comments"></a>Technical comments</h2>

<p>
In Lua 5.0 all C functions share the same environment
(which is obtained with the call <code>getfenv(0)</code> in Lua),
while in 5.1w6, each C function has its own environment,
which is the perfect place to store data.
This way,
C-upvalues became useless (they could be stored in the environment)
and are deprecated.
</p>
<p>
The implementation differences could be summarized in:
</p>
<ul>
  <li>Tables <code>package</code> and <code>package.loaded</code> are linked
    to functions <code>require()</code> and <code>module()</code> so that there
    is no way to change these tables <i>per se</i>, only its fields.</li>
  <li>Function <code>require()</code> uses a list of <i>loaders</i> which
    are functions responsible for trying to load a module.
    Table <code>package.loaders</code> store these functions.</li>
</ul>


<h2><a name="reference"></a>Reference</h2>

<dl class="history">

<dt><strong><code>module (name)</code></strong></dt>
<dd>Creates a module. The function creates a new global table
<i>name</i> (if it does not exists) and sets it as the environment
of the new module. This table will inherit from the original global
table so that it can access (but not change) global values
directly. It is also set as the value of
<code>package.loaded[<i>name</i>]</code> in order to be returned by
<code>require</code> function. Function <code>module</code> also defines
two names in the new namespace: <code>_NAME</code>, the module name;
and <code>_PACKAGE</code>, the package name.</dd>

<dt><strong><code>require (name)</code></strong></dt>
<dd>Loads a package. First, checks whether is is already loaded by
looking at table <code>package.loaded</code> with the given <i>name</i>
as the key. Otherwise, it checks for a function at table
<code>package.preload</code>. Otherwise, it looks for a file
<i>name</i> in the path <code>package.cpath</code>; if found, it tries
to call function <code>luaopen_<i>name</i></code> on that library to
open it. Otherwise, it looks for <i>name</i> in the path
<code>package.path</code>; if found, the file is loaded with
<code>loadfile</code> and run.<br/>
 Returns: the content of <code>package.loaded[<i>name</i>]</code> after
the execution of the whole file/function.</dd>

<dt><strong><code>static void luaL_module (lua_State *L, const char *libname, <br/>
	const luaL_reg *l, int nup)</code></strong></dt>
<dd>Modified version of <code>luaL_openlib</code> which stores the table
  where it opens the library in <code>package.loaded[<i>libname</i>]</code></dd>
  
</dl>


<h2><a name="examples"></a>Examples</h2>

<p>Suppose the file <code>m1.lua</code> is as follows:</p>

<pre class="example">
module("m1") -- in Lua 5.1 this should be changed to module(...)

local function format_words (x)
    return string.gsub (x, "(%w)(%w*)", function (i,s)
        return string.upper(i)..string.lower(s)
    end)
end

function format (x)
    return "prefix"..format_words(x).."sufix"
end
</pre>

<p>And here is a possible use of the module <code>m1.lua</code></p>

<pre class="example">
local f = require"m1"

assert (f == m1)
s = f.format"this is a test string"
print(s)
</pre>


<h2><a name="credits"></a>Credits</h2>

<p>Compat-5.1 was designed and implemented by Roberto
Ierusalimschy. The pair of C source and header files were coded by
Diego Nehab. The Lua file was adapted by Tom&aacute;s Guisasola to
work with the <a href="http://www.keplerproject.org/venv/">VEnv</a>
library. It is distributed and maintained by the
<a href="http://www.keplerproject.org">Kepler Project</a> which holds
its copyright.</p>


<h2><a name="contact"></a>Contact us</h2>

<p>For more information please <a href=
"mailto:info-NO-SPAM-THANKS@keplerproject.org">contact us</a>.
Comments are welcome!</p>

</div> <!-- id="content" -->

</div> <!-- id="main" -->

<div id="about">
	<p><a href="http://validator.w3.org/check?uri=referer"><img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0!" height="31" width="88" /></a></p>
	<p><small>
	$Id: index.html,v 1.21 2005-05-22 19:01:09 carregal Exp $
	</small></p>
</div> <!-- id="about" -->

</div> <!-- id="container" -->
</body>
</html> 

